<!-- build time:Tue Nov 06 2018 20:41:18 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh_CN" class="loading"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>iNode.VIP</title><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><meta name="keywords" content="iNode,iNodevip,iNode.vip,"><meta name="description" content="此处为Opus科普内容有兴趣者点击Opus是一个有损声音编码的格式，由Xiph.Org基金会开发，之后由IETF互联网工程任务组进行标准化，目标用希望用单一格式包含声音和语音，取代Speex和Vor,"><link rel="alternative" href="atom.xml" title="iNode.VIP" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><link rel="stylesheet" href="/css/diaspora.css"></head></html><body class="loading"><div id="loader"></div><div id="single"><div id="top" style="display:block"><div class="bar" style="width:0"></div><a class="icon-home image-icon" href="javascript:;"></a><div title="播放/暂停" class="icon-play"></div><h3 class="subtitle">在Android中使用Opus（编译使用Opus so库）</h3><div class="social"><div><div class="share"><a title="获取二维码" class="icon-scan" href="javascript:;"></a></div><div id="qr"></div></div></div><div class="scrollbar"></div></div><div class="section"><div class="article"><div class="main"><h1 class="title">在Android中使用Opus（编译使用Opus so库）</h1><div class="stuff"><span>九月 30, 2018</span><ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Android-Opus/">Android Opus</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/NDK-Compile-Opus/">NDK Compile Opus</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Opus/">Opus</a></li></ul></div><div class="content markdown"><p>此处为Opus科普内容有兴趣者点击</p><blockquote><p>Opus是一个有损声音编码的格式，由Xiph.Org基金会开发，之后由IETF互联网工程任务组进行标准化，目标用希望用单一格式包含声音和语音，取代Speex和Vorbis，且适用于网络上低延迟的即时声音传输，标准格式定义于RFC 6716文件。Opus格式是一个开放格式，使用上没有任何专利或限制。</p><p>Opus集成了两种声音编码的技术：以语音编码为导向的SILK和低延迟的CELT。Opus可以无缝调节高低比特率。在编码器内部它在较低比特率时使用线性预测编码在高比特率时候使用变换编码（在高低比特率交界处也使用两者结合的编码方式）。Opus具有非常低的算法延迟（默认为22.5 ms），非常适合用于低延迟语音通话的编码，像是网络上的即时声音流、即时同步声音旁白等等，此外Opus也可以透过降低编码位元率，达成更低的算法延迟，最低可以到5 ms。在多个听觉盲测中，Opus都比MP3、AAC、HE-AAC等常见格式，有更低的延迟和更好的声音压缩率 · · ·</p><p>Opus可以处理各种音频应用，包括IP语音、视频会议、游戏内聊天、流音乐、甚至远程现场音乐表演。它可以从低比特率窄带语音扩展到非常高清音频的立体声音乐。支持的功能包括：</p><ul><li>6 kb/秒到510 kb/秒的比特率；单一频道最高256 kb/秒</li><li>采样率从8 kHz（窄带）到48 kHz（全频）</li><li>帧大小从2.5毫秒到60毫秒</li><li>支持恒定比特率（CBR）、受约束比特率（CVBR）和可变比特率（VBR）</li><li>支持语音（SILK层）和音乐（CELT层）的单独或混合模式</li><li>支持单声道和立体声；支持多达255个音轨（多数据流的帧）</li><li>可动态调节比特率，音频带宽和帧大小</li><li>良好的鲁棒性丢失率和数据包丢失隐藏（PLC）</li><li>浮点和定点实现</li></ul><blockquote><p>来自：<a href="https://zh.wikipedia.org/wiki/Opus_&#40;%E9%9F%B3%E9%A2%91%E6%A0%BC%E5%BC%8F&#41;" target="_blank" rel="noopener">维基百科</a></p></blockquote></blockquote><h4 id="本文章所用到的项目源码：https-github-com-inodevip-OpusLibAndroidDemo"><a href="#本文章所用到的项目源码：https-github-com-inodevip-OpusLibAndroidDemo" class="headerlink" title="本文章所用到的项目源码：https://github.com/inodevip/OpusLibAndroidDemo"></a>本文章所用到的项目源码：<a href="https://github.com/inodevip/OpusLibAndroidDemo" target="_blank" rel="noopener">https://github.com/inodevip/OpusLibAndroidDemo</a></h4><h3 id="编译Opus库为libopus-so文件"><a href="#编译Opus库为libopus-so文件" class="headerlink" title="编译Opus库为libopus.so文件"></a>编译Opus库为libopus.so文件</h3><h4 id="官网下载代码到本地"><a href="#官网下载代码到本地" class="headerlink" title="官网下载代码到本地"></a>官网下载代码到本地</h4><blockquote><p>官方下载地址：<a href="http://opus-codec.org/downloads/" target="_blank" rel="noopener">http://opus-codec.org/downloads/</a></p><p>本文使用的是官方的<a href="http://opus-codec.org/release/stable/2017/06/26/libopus-1_2_1.html" target="_blank" rel="noopener">1.2.1版本</a>，不方便下载的同学也可以<a href="https://github.com/inodevip/OpusLibAndroidDemo/raw/master/opus-1.2.1.tar.gz" target="_blank" rel="noopener">点击这里下载</a></p></blockquote><h4 id="使用NDK-Build编译-TODO-小编是在Windows环境下编译"><a href="#使用NDK-Build编译-TODO-小编是在Windows环境下编译" class="headerlink" title="使用NDK-Build编译(TODO:小编是在Windows环境下编译)"></a>使用NDK-Build编译(TODO:小编是在Windows环境下编译)</h4><p>解压下载好的opus-1.2.1.tar.gz</p><h4 id="编写Android-mk文件到opus-1-2-1"><a href="#编写Android-mk文件到opus-1-2-1" class="headerlink" title="编写Android.mk文件到opus-1.2.1\"></a>编写Android.mk文件到opus-1.2.1\</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"><span class="comment">#我使用的是NDK 18</span></span><br><span class="line"><span class="comment">#NDK 17及以上不再支持ABIs [mips64, armeabi, mips]</span></span><br><span class="line">APP_ABI := armeabi-v7a arm64-v8a x86 x86_64</span><br><span class="line">APP_CPPFLAGS += -std=c++11</span><br><span class="line">APP_STL := gnustl_shared</span><br><span class="line">APP_PLATFORM := android-16</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(LOCAL_PATH)</span>/celt_sources.mk</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(LOCAL_PATH)</span>/silk_sources.mk</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(LOCAL_PATH)</span>/opus_sources.mk</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE        := opus</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fixed point sources</span></span><br><span class="line">SILK_SOURCES        += <span class="variable">$(SILK_SOURCES_FIXED)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ARM build</span></span><br><span class="line">CELT_SOURCES        += <span class="variable">$(CELT_SOURCES_ARM)</span></span><br><span class="line">SILK_SOURCES        += <span class="variable">$(SILK_SOURCES_ARM)</span></span><br><span class="line">LOCAL_SRC_FILES     := \</span><br><span class="line">    <span class="variable">$(CELT_SOURCES)</span> <span class="variable">$(SILK_SOURCES)</span> <span class="variable">$(OPUS_SOURCES)</span> <span class="variable">$(OPUS_SOURCES_FLOAT)</span></span><br><span class="line"></span><br><span class="line">LOCAL_LDLIBS        := -lm -llog</span><br><span class="line">LOCAL_C_INCLUDES    := \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/<span class="keyword">include</span> \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/silk \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/silk/fixed \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/celt</span><br><span class="line">LOCAL_CFLAGS        := -DNULL=0 -DSOCKLEN_T=socklen_t -DLOCALE_NOT_USED -D_LARGEFILE_SOURCE=1 -D_FILE_OFFSET_BITS=64</span><br><span class="line">LOCAL_CFLAGS        += -Drestrict='' -D__EMX__ -DOPUS_BUILD -DFIXED_POINT -DUSE_ALLOCA -DHAVE_LRINT -DHAVE_LRINTF -O3 -fno-math-errno</span><br><span class="line">LOCAL_CPPFLAGS      := -DBSD=1 </span><br><span class="line">LOCAL_CPPFLAGS      += -ffast-math -O3 -funroll-loops</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd opus-1.2.1</span><br><span class="line">$ android-sdk-windows\ndk-bundle\ndk-build.cmd APP_BUILD_SCRIPT=Android.mk NDK_PROJECT_PATH=.</span><br></pre></td></tr></table></figure><p>输出如下：</p><img src="/Android-Use-Opus-Audio-Lib/compile_arm64-v8a.png" title="arm64-v8a库编译完成输出"> <img src="/Android-Use-Opus-Audio-Lib/compile_armeabi-v7a.png" title="armeabi-v7a库编译完成输出"> <img src="/Android-Use-Opus-Audio-Lib/compile_x86_64.png" title="x86_64库编译完成输出"> <img src="/Android-Use-Opus-Audio-Lib/compile_x86.png" title="x86库编译完成输出"><h3 id="在Android中使用so库"><a href="#在Android中使用so库" class="headerlink" title="在Android中使用so库"></a>在Android中使用so库</h3><h4 id="拷贝文件至Android项目中"><a href="#拷贝文件至Android项目中" class="headerlink" title="拷贝文件至Android项目中"></a>拷贝文件至Android项目中</h4><p>opus-1.2.1/include —&gt; app\src\main\cpp\<br>opus-1.2.1/libs/* —&gt; app\src\main\jniLibs\</p><img src="/Android-Use-Opus-Audio-Lib/copy_opus_lib_files.png" title="拷贝头文件和so库"><h4 id="以下为JNI文件内容"><a href="#以下为JNI文件内容" class="headerlink" title="以下为JNI文件内容"></a>以下为JNI文件内容</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jlong JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_createEncoder</span><br><span class="line">        (JNIEnv *env, jobject thiz, jint sampleRateInHz, jint channelConfig, jint complexity) &#123;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    OpusEncoder *pOpusEnc = opus_encoder_create(sampleRateInHz, channelConfig,</span><br><span class="line">                                                OPUS_APPLICATION_RESTRICTED_LOWDELAY,</span><br><span class="line">                                                &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (pOpusEnc) &#123;</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_VBR(<span class="number">0</span>));<span class="comment">//0:CBR, 1:VBR</span></span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_VBR_CONSTRAINT(<span class="literal">true</span>));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_BITRATE(<span class="number">32000</span>));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_COMPLEXITY(complexity));<span class="comment">//8    0~10</span></span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_SIGNAL(OPUS_SIGNAL_VOICE));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_LSB_DEPTH(<span class="number">16</span>));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_DTX(<span class="number">0</span>));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_INBAND_FEC(<span class="number">0</span>));</span><br><span class="line">        opus_encoder_ctl(pOpusEnc, OPUS_SET_PACKET_LOSS_PERC(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (jlong) pOpusEnc;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jlong JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_createDecoder</span><br><span class="line">        (JNIEnv *env, jobject thiz, jint sampleRateInHz, jint channelConfig) &#123;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    OpusDecoder *pOpusDec = opus_decoder_create(sampleRateInHz, channelConfig, &amp;error);</span><br><span class="line">    <span class="keyword">return</span> (jlong) pOpusDec;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jint JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_encode</span><br><span class="line">        (JNIEnv *env, jobject thiz, jlong pOpusEnc, jshortArray samples, jint offset,</span><br><span class="line">         jbyteArray bytes) &#123;</span><br><span class="line">    OpusEncoder *pEnc = (OpusEncoder *) pOpusEnc;</span><br><span class="line">    <span class="keyword">if</span> (!pEnc || !samples || !bytes)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    jshort *pSamples = env-&gt;GetShortArrayElements(samples, <span class="number">0</span>);</span><br><span class="line">    jsize nSampleSize = env-&gt;GetArrayLength(samples);</span><br><span class="line">    jbyte *pBytes = env-&gt;GetByteArrayElements(bytes, <span class="number">0</span>);</span><br><span class="line">    jsize nByteSize = env-&gt;GetArrayLength(bytes);</span><br><span class="line">    <span class="keyword">if</span> (nSampleSize - offset &lt; <span class="number">320</span> || nByteSize &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> nRet = opus_encode(pEnc, pSamples + offset, nSampleSize, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *) pBytes,</span><br><span class="line">                           nByteSize);</span><br><span class="line">    env-&gt;ReleaseShortArrayElements(samples, pSamples, <span class="number">0</span>);</span><br><span class="line">    env-&gt;ReleaseByteArrayElements(bytes, pBytes, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jint JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_decode</span><br><span class="line">        (JNIEnv *env, jobject thiz, jlong pOpusDec, jbyteArray bytes,</span><br><span class="line">         jshortArray samples) &#123;</span><br><span class="line">    OpusDecoder *pDec = (OpusDecoder *) pOpusDec;</span><br><span class="line">    <span class="keyword">if</span> (!pDec || !samples || !bytes)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    jshort *pSamples = env-&gt;GetShortArrayElements(samples, <span class="number">0</span>);</span><br><span class="line">    jbyte *pBytes = env-&gt;GetByteArrayElements(bytes, <span class="number">0</span>);</span><br><span class="line">    jsize nByteSize = env-&gt;GetArrayLength(bytes);</span><br><span class="line">    jsize nShortSize = env-&gt;GetArrayLength(samples);</span><br><span class="line">    <span class="keyword">if</span> (nByteSize &lt;= <span class="number">0</span> || nShortSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nRet = opus_decode(pDec, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *) pBytes, nByteSize, pSamples, nShortSize, <span class="number">0</span>);</span><br><span class="line">    env-&gt;ReleaseShortArrayElements(samples, pSamples, <span class="number">0</span>);</span><br><span class="line">    env-&gt;ReleaseByteArrayElements(bytes, pBytes, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> nRet;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_destroyEncoder</span><br><span class="line">        (JNIEnv *env, jobject thiz, jlong pOpusEnc) &#123;</span><br><span class="line">    OpusEncoder *pEnc = (OpusEncoder *) pOpusEnc;</span><br><span class="line">    <span class="keyword">if</span> (!pEnc)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    opus_encoder_destroy(pEnc);</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_vip_inode_demo_opusaudiodemo_utils_OpusUtils_destroyDecoder</span><br><span class="line">        (JNIEnv *env, jobject thiz, jlong pOpusDec) &#123;</span><br><span class="line">    OpusDecoder *pDec = (OpusDecoder *) pOpusDec;</span><br><span class="line">    <span class="keyword">if</span> (!pDec)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    opus_decoder_destroy(pDec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试编解码"><a href="#测试编解码" class="headerlink" title="测试编解码"></a>测试编解码</h3><h4 id="编码PCM为Opus-Kotlin"><a href="#编码PCM为Opus-Kotlin" class="headerlink" title="编码PCM为Opus (Kotlin)"></a>编码PCM为Opus (Kotlin)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    isRecorder = <span class="literal">true</span></span><br><span class="line">    audioRecord.startRecording()</span><br><span class="line">    <span class="keyword">val</span> file = File(opusAudioOpusPath)</span><br><span class="line">    <span class="keyword">val</span> filePcm = File(opusAudioPcmPath)</span><br><span class="line">    <span class="keyword">val</span> fileDir = File(file.parent)</span><br><span class="line">    <span class="keyword">if</span> (!fileDir.exists()) &#123;</span><br><span class="line">        fileDir.mkdirs()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        file.delete()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (filePcm.exists()) &#123;</span><br><span class="line">        filePcm.delete()</span><br><span class="line">    &#125;</span><br><span class="line">    file.createNewFile()</span><br><span class="line">    filePcm.createNewFile()</span><br><span class="line">    <span class="keyword">val</span> fileOutputStream = FileOutputStream(file, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">val</span> filePcmOutputStream = FileOutputStream(filePcm, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileOpusBufferedOutputStream = BufferedOutputStream(fileOutputStream)<span class="comment">//默认buffer大小8192</span></span><br><span class="line">    <span class="keyword">val</span> filePcmBufferedOutputStream = BufferedOutputStream(filePcmOutputStream)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> opusUtils = OpusUtils()</span><br><span class="line">    <span class="keyword">val</span> createEncoder = opusUtils.createEncoder(DEFAULT_AUDIO_SAMPLE_RATE, DEFAULT_OPUS_CHANNEL, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (isRecorder) &#123;</span><br><span class="line">        <span class="keyword">val</span> curShortSize = audioRecord.read(audioBuffer, <span class="number">0</span>, audioBuffer.size)</span><br><span class="line">        <span class="keyword">if</span> (curShortSize &gt; <span class="number">0</span> &amp;&amp; curShortSize &lt;= audioBuffer.size) &#123;</span><br><span class="line">            filePcmBufferedOutputStream.write(audioBuffer)<span class="comment">//同时保存PCM以对比检查问题</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> byteArray = ByteArray(audioBuffer.size / <span class="number">8</span>)<span class="comment">//编码后大小减小8倍</span></span><br><span class="line">            <span class="keyword">val</span> encodeSize = opusUtils.encode(createEncoder, Uilts.byteArrayToShortArray(audioBuffer), <span class="number">0</span>, byteArray)</span><br><span class="line">            <span class="keyword">if</span> (encodeSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">val</span> decodeArray = ByteArray(encodeSize)</span><br><span class="line">                System.arraycopy(byteArray, <span class="number">0</span>, decodeArray, <span class="number">0</span>, encodeSize)</span><br><span class="line">                fileOpusBufferedOutputStream.write(decodeArray)<span class="comment">//写入OPUS</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    opusUtils.destroyEncoder(createEncoder)</span><br><span class="line">    audioRecord.stop()</span><br><span class="line">    audioRecord.release()</span><br><span class="line">    filePcmBufferedOutputStream.close()</span><br><span class="line">    filePcmOutputStream.close()</span><br><span class="line">    fileOpusBufferedOutputStream.close()</span><br><span class="line">    fileOutputStream.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解码Opus为PCM-Kotlin"><a href="#解码Opus为PCM-Kotlin" class="headerlink" title="解码Opus为PCM (Kotlin)"></a>解码Opus为PCM (Kotlin)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">opusFileDecoder</span><span class="params">(needDecoder: <span class="type">Boolean</span> = <span class="literal">true</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (decodeOpusFilePath.isNullOrEmpty()) &#123;</span><br><span class="line">        opusDecodeFinish()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> tntOpusUtils = OpusUtils.getInstant()</span><br><span class="line">    <span class="keyword">val</span> decoderHandler = tntOpusUtils.createDecoder(DEFAULT_AUDIO_SAMPLE_RATE, DEFAULT_OPUS_CHANNEL)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fis: FileInputStream</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis = FileInputStream(decodeOpusFilePath)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        opusDecodeFinish()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> bis = BufferedInputStream(fis)</span><br><span class="line">    <span class="keyword">while</span> (!isCancel) &#123;</span><br><span class="line">        <span class="keyword">val</span> bufferArray = ByteArray(BUFFER_LENGTH)</span><br><span class="line">        <span class="keyword">var</span> read: <span class="built_in">Int</span> = <span class="number">-1</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            read = bis.read(bufferArray, <span class="number">0</span>, bufferArray.size)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (read &lt; <span class="number">0</span>) &#123;<span class="comment">//已经读完了</span></span><br><span class="line">            Log.i(TAG, <span class="string">"OpusFileDecoder compare"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (needDecoder) &#123;</span><br><span class="line">                <span class="keyword">val</span> decodeBufferArray = ShortArray(bufferArray.size * <span class="number">4</span>)</span><br><span class="line">                <span class="keyword">val</span> size = tntOpusUtils.decode(decoderHandler, bufferArray, decodeBufferArray)</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">val</span> decodeArray = ShortArray(size)</span><br><span class="line">                    System.arraycopy(decodeBufferArray, <span class="number">0</span>, decodeArray, <span class="number">0</span>, size)</span><br><span class="line">                    opusDecode(decodeArray)<span class="comment">//输出数据到接口</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"opusDecode error : <span class="variable">$size</span>"</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                opusDecode(byteArrayToShortArray(bufferArray))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    tntOpusUtils.destroyDecoder(decoderHandler)</span><br><span class="line">    bis.close()</span><br><span class="line">    fis.close()</span><br><span class="line">    opusDecodeFinish()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]--><audio id="audio" loop preload="auto" controls data-autoplay="true"><source type="audio/mpeg" src=""></audio><ul id="audio-list" style="display:none"><li title="0" data-url="/music/Nick Jonas - Find You.mp3"></li><li title="1" data-url="https://link.hhtjim.com/163/5146554.mp3"></li><li title="2" data-url="https://link.hhtjim.com/qq/001faIUs4M2zna.mp3"></li></ul></div><div id="gitalk-container" class="comment link" data-ae="false" data-ci="8227bc4605f9f7f3b73d" data-cs="aaee7c94004c979c134a4349681d4e078e5b2bbc" data-r="inodevip.github.io" data-o="inodevip" data-a="inodevip" data-d="false">查看评论</div></div></div></div></div></body><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script><script src="/js/plugin.js"></script><script src="/js/diaspora.js"></script><link rel="stylesheet" href="/photoswipe/photoswipe.css"><link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css"><script src="/photoswipe/photoswipe.min.js"></script><script src="/photoswipe/photoswipe-ui-default.min.js"></script><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title="Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c0bf1c79802102ea24d900bbd2158a88";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-128755179-1","auto"),ga("send","pageview")</script><!-- rebuild by neat -->